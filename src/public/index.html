<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>focknews</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #050505;
      --surface: #0c0c0c;
      --surface2: #111113;
      --border: #1a1a1e;
      --border-hi: #2a2a30;
      --text: #c8c8d0;
      --text-dim: #5a5a66;
      --text-muted: #3a3a44;
      --accent: #ff3333;
      --accent-glow: rgba(255, 51, 51, 0.15);
      --accent2: #6e56ff;
      --accent2-glow: rgba(110, 86, 255, 0.12);
      --green: #22c55e;
      --amber: #f59e0b;
      --font: 'Space Grotesk', -apple-system, sans-serif;
      --mono: 'JetBrains Mono', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ---- Noise texture overlay ---- */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
    }

    .container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 1.8rem 1.5rem;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.8rem;
      padding-bottom: 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.04em;
      line-height: 1;
    }

    h1 .accent { color: var(--accent); }

    .logo-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 12px var(--accent), 0 0 24px var(--accent-glow);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.85); }
    }

    .header-meta {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: right;
      line-height: 1.6;
    }

    .header-meta strong { color: var(--text-dim); font-weight: 500; }

    /* ---- Toolbar ---- */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .filters { display: flex; gap: 0.35rem; flex-wrap: wrap; }

    .pill {
      font-family: var(--mono);
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.32rem 0.7rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.68rem;
      transition: all 0.2s;
      letter-spacing: 0.01em;
    }

    .pill:hover { border-color: var(--border-hi); color: var(--text); background: var(--surface2); }
    .pill.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 500; }

    .separator {
      width: 1px;
      height: 18px;
      background: var(--border);
      margin: 0 0.3rem;
    }

    .sort-pills { display: flex; gap: 0.35rem; margin-left: auto; }

    .sort-pill {
      font-family: var(--mono);
      background: none;
      border: 1px solid transparent;
      color: var(--text-muted);
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.65rem;
      transition: all 0.2s;
    }

    .sort-pill:hover { color: var(--text-dim); }
    .sort-pill.active { border-color: var(--border-hi); color: var(--text); }

    /* ---- Board Grid ---- */
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      grid-auto-flow: dense;
    }

    /* ---- Cards ---- */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.4rem 1.5rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 100px;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border-hi), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover {
      border-color: var(--border-hi);
      transform: translateY(-3px) scale(1.008);
      box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.03);
    }

    .card:hover::before { opacity: 1; }

    /* -- XL: Hero card -- full width, massive headline -- */
    .card.xl {
      grid-column: span 3;
      padding: 2.8rem 3.2rem;
      background: linear-gradient(135deg, #180808 0%, #100606 40%, var(--surface) 100%);
      border-color: #441111;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .card.xl::after {
      content: '';
      position: absolute;
      top: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #ff6644 40%, transparent 80%);
    }

    .card.xl .card-title {
      font-size: 2.4rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.15;
      letter-spacing: -0.035em;
    }

    .card.xl .card-footer { margin-top: 1.2rem; }

    /* -- LG -- spans 2 columns, prominent -- */
    .card.lg {
      grid-column: span 2;
      padding: 1.8rem 2rem;
      background: linear-gradient(135deg, #0a0a18 0%, #080816 40%, var(--surface) 100%);
      border-color: #222244;
      min-height: 120px;
    }

    .card.lg::after {
      content: '';
      position: absolute;
      top: -1px;
      left: 0;
      width: 50%;
      height: 3px;
      background: linear-gradient(90deg, var(--accent2), #8866ff 40%, transparent);
    }

    .card.lg .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #eee;
      line-height: 1.25;
      letter-spacing: -0.02em;
    }

    .card.lg .card-footer { margin-top: 0.9rem; }

    /* -- MD -- single column, still bold -- */
    .card.md {
      grid-column: span 1;
      padding: 1.3rem 1.4rem;
    }

    .card.md .card-title {
      font-size: 1.05rem;
      font-weight: 500;
      color: #ddd;
      line-height: 1.3;
    }

    /* -- SM -- compact but readable -- */
    .card.sm {
      grid-column: span 1;
      padding: 1rem 1.1rem;
      border-color: #151518;
    }

    .card.sm .card-title {
      font-size: 0.9rem;
      color: #aaa;
      font-weight: 400;
      line-height: 1.3;
    }

    .card.sm .card-footer { margin-top: 0.4rem; }

    /* ---- Card elements ---- */
    .card-title {
      color: var(--text);
      text-decoration: none;
      display: block;
      line-height: 1.35;
      font-weight: 500;
      font-size: 1.05rem;
    }

    .card-title:hover { color: var(--accent); }

    .card-footer {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      margin-top: 0.7rem;
    }

    .source-tag {
      font-family: var(--mono);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: #141418;
      padding: 0.2rem 0.6rem;
      border-radius: 5px;
      font-size: 0.7rem;
      color: var(--text-dim);
      border: 1px solid var(--border);
    }

    .source-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .source-dot.dw { background: #0088cc; box-shadow: 0 0 6px rgba(0,136,204,0.4); }
    .source-dot.nbc { background: #ffb800; box-shadow: 0 0 6px rgba(255,184,0,0.4); }
    .source-dot.mongabay { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.4); }
    .source-dot.default { background: var(--text-muted); }

    .card.xl .source-tag { font-size: 0.8rem; padding: 0.25rem 0.7rem; }
    .card.lg .source-tag { font-size: 0.75rem; }

    .card-time {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .card.xl .card-time { font-size: 0.8rem; color: var(--text-dim); }
    .card.lg .card-time { font-size: 0.75rem; }

    /* ---- Badges ---- */
    .badge {
      font-family: var(--mono);
      display: inline-block;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.2rem 0.6rem;
      border-radius: 5px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.6rem;
    }

    .badge-hot {
      background: linear-gradient(135deg, #ff3333, #cc2200);
      color: #fff;
      box-shadow: 0 2px 16px var(--accent-glow), 0 0 30px rgba(255,51,51,0.08);
      animation: badge-glow 2s ease-in-out infinite alternate;
    }

    @keyframes badge-glow {
      from { box-shadow: 0 2px 16px var(--accent-glow); }
      to { box-shadow: 0 2px 24px rgba(255,51,51,0.25); }
    }

    .badge-multi {
      background: linear-gradient(135deg, var(--accent2), #5040cc);
      color: #ddd;
      box-shadow: 0 2px 16px var(--accent2-glow);
    }

    .card.xl .badge { font-size: 0.75rem; padding: 0.25rem 0.7rem; margin-bottom: 0.8rem; }

    .cluster-sources {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .cluster-sources .source-tag {
      opacity: 0.7;
      font-size: 0.6rem;
    }

    /* ---- Live indicator ---- */
    .live-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 1.2rem;
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    .live-bar span { color: var(--text-dim); }

    /* ---- States ---- */
    .loading, .empty {
      text-align: center;
      padding: 5rem 2rem;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .loading::after {
      content: '';
      display: block;
      width: 24px;
      height: 24px;
      margin: 1rem auto 0;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- Responsive ---- */
    @media (max-width: 1100px) {
      .board { grid-template-columns: repeat(2, 1fr); }
      .card.xl { grid-column: span 2; }
      .card.xl .card-title { font-size: 1.8rem; }
    }

    @media (max-width: 768px) {
      .board { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .card.xl { grid-column: span 2; padding: 1.8rem; }
      .card.xl .card-title { font-size: 1.5rem; }
      .card.lg { grid-column: span 2; }
      .card.lg .card-title { font-size: 1.2rem; }
      .container { padding: 1rem; }
    }

    @media (max-width: 520px) {
      .board { grid-template-columns: 1fr; gap: 10px; }
      .card.xl, .card.lg { grid-column: span 1; }
      .card.xl { padding: 1.5rem; }
      .card.xl .card-title { font-size: 1.35rem; }
      .card.lg { padding: 1.3rem; }
      .card.lg .card-title { font-size: 1.1rem; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .sort-pills { margin-left: 0; }
      .separator { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>fock<span class="accent">news</span></h1>
        <div class="logo-dot"></div>
      </div>
      <div class="header-meta" id="header-meta">
        <div><strong id="count">0</strong> articles</div>
        <div>3 sources</div>
      </div>
    </header>

    <div class="live-bar">
      <div class="live-dot"></div>
      <span>live</span> &mdash; auto-refreshes every 10 min
    </div>

    <div class="toolbar">
      <div class="filters" id="filters"></div>
      <div class="separator"></div>
      <div class="sort-pills">
        <button class="sort-pill active" data-sort="date">latest</button>
        <button class="sort-pill" data-sort="score">trending</button>
      </div>
    </div>

    <div id="content"><p class="loading">Fetching headlines</p></div>
  </div>

  <script>
    let currentSource = null;
    let currentSort = 'date';

    const SOURCE_COLORS = {
      'Deutsche Welle': 'dw',
      'NBC News': 'nbc',
      'Mongabay': 'mongabay',
    };

    async function loadNews() {
      const params = new URLSearchParams();
      if (currentSource) params.set('source', currentSource);
      params.set('sort', currentSort);

      try {
        const res = await fetch(`/api/news?${params}`);
        const data = await res.json();
        renderFilters(data.sources);
        renderBoard(data.articles);
        document.getElementById('count').textContent = data.count;
        document.querySelector('.header-meta div:last-child').textContent =
          `${data.sources.length} sources`;
      } catch {
        document.getElementById('content').innerHTML =
          '<p class="empty">Failed to load. Try refreshing.</p>';
      }
    }

    // Sort pills
    document.querySelectorAll('.sort-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        loadNews();
      });
    });

    function renderFilters(sources) {
      const el = document.getElementById('filters');
      const opts = [{ label: 'all', value: null }, ...sources.map(s => ({ label: s, value: s }))];

      el.innerHTML = opts.map(o =>
        `<button class="pill ${o.value === currentSource ? 'active' : ''}"
                 data-source="${o.value || ''}">${o.label}</button>`
      ).join('');

      el.querySelectorAll('.pill').forEach(btn => {
        btn.addEventListener('click', () => {
          currentSource = btn.dataset.source || null;
          loadNews();
        });
      });
    }

    function tier(score, idx) {
      if (score >= 60) return 'xl';
      if (score > 0) return 'lg';
      if (idx < 6) return 'md';
      return 'sm';
    }

    // Dynamic font size: scales with score, position, and recency
    function titleSize(score, idx) {
      if (score >= 90) return '2.8rem';
      if (score >= 60) return '2.2rem';
      if (score >= 30) return '1.6rem';
      if (score > 0) return '1.35rem';
      // For unscored: first few are bigger, then taper
      if (idx === 0) return '1.3rem';
      if (idx < 3) return '1.15rem';
      if (idx < 8) return '1.0rem';
      if (idx < 20) return '0.9rem';
      return '0.82rem';
    }

    function sourceDot(name) {
      return `<span class="source-dot ${SOURCE_COLORS[name] || 'default'}"></span>`;
    }

    function sourceTag(name) {
      return `<span class="source-tag">${sourceDot(name)}${esc(name)}</span>`;
    }

    function renderBoard(articles) {
      const box = document.getElementById('content');

      if (!articles.length) {
        box.innerHTML = '<p class="empty">No articles yet. Waiting for first fetch.</p>';
        return;
      }

      // Cluster multi-source articles into single cards
      const clusterMap = new Map();
      const solo = [];

      for (const a of articles) {
        if (a.score > 0 && a.cluster_id) {
          if (!clusterMap.has(a.cluster_id)) clusterMap.set(a.cluster_id, []);
          clusterMap.get(a.cluster_id).push(a);
        } else {
          solo.push(a);
        }
      }

      const cards = [];

      for (const [, group] of clusterMap) {
        const rep = group.reduce((best, a) => {
          if (!best.published_at) return a;
          if (!a.published_at) return best;
          return new Date(a.published_at) > new Date(best.published_at) ? a : best;
        }, group[0]);
        cards.push({
          ...rep,
          _others: group.filter(a => a.id !== rep.id).map(a => a.source),
        });
      }

      for (const a of solo) cards.push(a);

      if (currentSort === 'score') {
        cards.sort((a, b) => (b.score || 0) - (a.score || 0));
      } else {
        cards.sort((a, b) => {
          const da = a.published_at ? new Date(a.published_at) : new Date(0);
          const db_ = b.published_at ? new Date(b.published_at) : new Date(0);
          return db_ - da;
        });
      }

      box.innerHTML = `<div class="board">${cards.map((a, i) => {
        const s = a.score || 0;
        const t = tier(s, i);
        const fs = titleSize(s, i);
        const fw = s >= 60 ? 700 : s > 0 ? 600 : (i < 3 ? 600 : (i < 8 ? 500 : 400));
        const tc = s >= 60 ? '#fff' : s > 0 ? '#eee' : (i < 8 ? '#ddd' : '#aaa');

        const badge = s >= 60
          ? '<div class="badge badge-hot">HOT</div>'
          : s > 0
            ? '<div class="badge badge-multi">multi-source</div>'
            : '';

        const others = a._others && a._others.length
          ? `<div class="cluster-sources">${a._others.map(src => sourceTag(src)).join('')}</div>`
          : '';

        return `<article class="card ${t}">
          ${badge}
          <a class="card-title" href="${esc(a.url)}" target="_blank" rel="noopener"
             style="font-size:${fs};font-weight:${fw};color:${tc}">${esc(a.title)}</a>
          <div class="card-footer">
            ${sourceTag(a.source)}
            ${a.published_at ? `<span class="card-time">${timeAgo(a.published_at)}</span>` : ''}
          </div>
          ${others}
        </article>`;
      }).join('')}</div>`;
    }

    function timeAgo(iso) {
      const ms = Date.now() - new Date(iso).getTime();
      const m = Math.floor(ms / 60000);
      if (m < 1) return 'now';
      if (m < 60) return `${m}m`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h}h`;
      if (h < 48) return 'yesterday';
      const d = Math.floor(h / 24);
      if (d < 7) return `${d}d`;
      return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    loadNews();

    // Auto-refresh every 10 min
    setInterval(loadNews, 10 * 60 * 1000);
  </script>
</body>
</html>
